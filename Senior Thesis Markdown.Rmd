---
title: "Senior Thesis"
author: "Dustin Lind"
date: "1/27/2022"
output: html_document
---


## Install Packages
```{r}
library(tidyverse)
```


## Import Data
```{r}
Compustat_AF_1962_2020 <- read_csv("Compustat_AF_1962_2020.csv")
CRSP_MS_1962_2020 <- read_csv("CRSP_MS_1962_2020.csv")
```

## Data Dictionary

### CRSP Monthly Stock (CRSP_MS_1962_2020)
1. PERMNO - CRSP Permanent Company Number
2. date - date
3. SHRCD - Share Code
4. EXCHCD - Exchange Code
5. PERMCO - CRSP Permanent Company Number
6. PRC - Price
7. RET - Holding Period Return
8. SHROUT - Number of Shares Outstanding

### Compustat Annual Fundamentals (Compustat_AF_1962_2920)
1. GVKEY - Standard and Poor's Identifier
2. LPERMNO - Historical CRSP PERMNO Link to COMPUSTAT Record
3. LPERMCO - Historical CRSP PERMCO Link to COMPUSTAT Record 
4. datadate
5. fyear - fiscal year
6. indfmt
7. consol
8. popsrc
9. datafmt
10. conm - Company Name
11. curcd
12. fyr - Fiscal Year-End
13. at - Assets - Total
14. capx - Capital Expenditures
15. gp - Gross Profit
17. ni - Net Income
18. rdip -  In Process R&D Expense
19. revt - Revenue - Total
20. xad - Advertising Expense
21. xrd - Research and Development Expense
22. xsga - Selling, General and Administrative Expense
23. costat 
24. ggroup - GIC Groups
25. gind - GIC Industries
26. gsector - GIC Sectors
27. gsubind - GIC Sub-Industries

## Data Cleaning/Filtering

```{r}
Compustat_AF <- Compustat_AF_1962_2020 %>%
  mutate(year = as.numeric(substr(datadate, 7, 10))) %>% # create year variable
  mutate(month = as.numeric(substr(datadate, 1, 2))) %>% # create month variable
  rename(PERMNO =  LPERMNO)
  
Compustat_AF <- Compustat_AF %>%
  select(-c(GVKEY, indfmt, consol, popsrc, datafmt, curcd, costat, rdip, fyr, datadate, LPERMCO)) # remove unnecessary variables

Compustat_AF <- Compustat_AF %>%
  distinct(PERMNO, fyear, .keep_all = TRUE) # remove potential duplicate data

Compustat_AF <- Compustat_AF %>%
  select(-c(ggroup, gind, gsector, gsubind)) # remove GIC values - might use later
```

```{r}
CRSP_MS <- CRSP_MS_1962_2020 %>% 
  mutate(year = as.numeric(substr(date, 7, 10))) %>% # create year variable
  mutate(month = as.numeric(substr(date, 1, 2))) # create month variable
  
CRSP_MS <- CRSP_MS %>% 
  distinct(PERMNO, year, month, .keep_all = TRUE) # remove potential duplicate data

CRSP_MS <- CRSP_MS %>%
  filter(EXCHCD==1 | EXCHCD==2 | EXCHCD==3) %>% # keep stocks traded on NYSE, AMEX, or NASDAQ
  filter(!(SHRCD>12)) # confirm the codes remaining are 10, 11, 12

CRSP_MS <- CRSP_MS %>%
  select(-c(EXCHCD, SHRCD, PERMCO)) # remove unnecessary variables

  
```

### Merging

#### Function to find periods
```{r}
monthdiff <- function(from_date = "1/31/1962", to_date = "1/31/1962")
{ 
  from_date <- as.Date(from_date, "%m/%d/%Y") # assuming from_date is a character string
  to_date <- as.Date(to_date, "%m/%d/%Y") # assuming to_date is a character string 
  if(from_date <= to_date )
    return( length(seq(from = as.Date(from_date), to = as.Date(to_date), by = "month")) - 1 )
  else
    return(NA)
}
```


```{r}
CRSP_Compustat <- left_join(CRSP_MS, Compustat_AF) # merge the two datasets (I feel like I'm not merging correctly here)

```

```{r}
CRSP_Compustat <- CRSP_Compustat %>% 
  distinct(PERMNO, year, month, .keep_all = TRUE) %>% # remove duplicate data
  distinct(PERMNO, fyear, .keep_all = TRUE) # ^^
```

```{r}
CRSP_Compustat <- CRSP_Compustat %>%
  mutate(period = lapply(date, monthdiff, from_date = "1/31/1962"))

CRSP_Compustat <- CRSP_Compustat %>%
  mutate(xrd = ifelse(xrd < 0, 0, xrd)) %>% # change R&D to 0 in the cases where it it is negative
  mutate(xad = ifelse(xad < 0, 0, xad)) %>% # likewise for advertising expense
  mutate(xsga = ifelse(xsga < 0, 0, xsga)) %>% # likewise for SG&A
  mutate(xsga = ifelse(capx < 0, 0, capx)) # likewise for capital expenditures
```

```{r}
CRSP_Compustat <- CRSP_Compustat %>%
  group_by(PERMNO) %>% # signify to R that the data are panel data
  arrange(PERMNO, fyear) # arrange the data
```


```{r, echo=FALSE}
CRSP_Compustat <- CRSP_Compustat %>%
  mutate(sales_growth = 
           ifelse(is.na(revt) | is.na(lag(revt,1)), NA,  log(revt/lag(revt,1)))) # compute sales growth

CRSP_Compustat <- CRSP_Compustat %>%
  mutate(RDI = ifelse(is.na(revt) | is.na(xrd), NA, log(1+xrd/revt))) # compute R&D intensity metric
```

### Ability Regressions

```{r}
# generate the b variables
CRSP_Compustat_for <- CRSP_Compustat

CRSP_Compustat_for <- CRSP_Compustat_for %>%
  mutate(b1 = NA) %>%
  mutate(b2 = NA) %>%
  mutate(b3 = NA) %>%
  mutate(b4 = NA) %>%
  mutate(b5 = NA)
```

```{r}
var_name <- function(i) {
  var <- paste('b', i, sep = '')
  return(var)
}
```


```{r}
for (i in 1:5){ # the lags - 1 to 5 year lags
  for (t in 1978:2015){ # the data time range
    CRSP_Compustat_for <- CRSP_Compustat_for %>%
      mutate(reg_period = (fyear<=t)*(fyear>=(t-7))) %>%
      mutate(x_use = ifelse(reg_period, lag(RDI, i), NA)) %>%
      mutate(y_use = ifelse(reg_period, sales_growth, NA)) %>%
      mutate(x_use = ifelse(is.na(y_use), NA, x_use)) %>%
      mutate(y_use = ifelse(is.na(y_use), NA, y_use))
    
    CRSP_Compustat_for <- CRSP_Compustat_for %>%
      mutate(RDI_nm_chk = (x_use<NA)*reg_period) %>%
      mutate(RDI_pos_chk = (x_use<NA)*(x_use>0)*reg_period) %>%
      group_by(PERMNO) %>%
      mutate(RDI_nm_ind = sum(RDI_nm_chk)) %>%
      mutate(RDI_pos_ind = sum(RDI_pos_chk)) %>%
      mutate(perc_pos = RDI_pos_ind/8)
    
    CRSP_Compustat_for <- CRSP_Compustat_for %>%
      group_by(PERMNO) %>%
      mutate(mean_x = mean(x_use)) %>%
      mutate(mean_y = mean(y_use)) %>%
      mutate(dev_x = x_use - mean_x) %>%
      mutate(dev_y = y_use - mean_y) %>%
      mutate(yx_term = dev_x*dev_y) %>%
      mutate(xx_term = dev_x*dev_x) %>%
      mutate(sum_yx = sum(yx_term)) %>%
      mutate(sum_xx = sum(xx_term))
    # trying to do a find the regression coefficient for each of the lagged years (see my tests below)
  }
}
```


### Tests

```{r}
vars <- c("b1", "b2", "b3", "b4", "b5")
for (i in 1:5){
  CRSP_Compustat_for <- CRSP_Compustat_for %>%
      mutate_(vars[i] = 1)
}
```

```{r}
CRSP_Compustat_for <- CRSP_Compustat_for %>%
  mutate("b1" = 1)
```
```{r}
paste("b", 1, sep = "")
```


```{r}
CRSP_Compustat_for <- CRSP_Compustat_for %>%
  mutate(reg_period = (fyear<=1978)*(fyear>=(1978-7)))
```

```{r}
mean_x = CRSP_Compustat_for %>% 
  group_by(PERMNO) %>%
  summarize(mean = mean(revt, na.rm = TRUE))

mean_x
```






#### Questions
1. Is the code from 102-104 the same as in lines 62-65 of the STATA do file?



